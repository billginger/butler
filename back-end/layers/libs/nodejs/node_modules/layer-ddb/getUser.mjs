import { QueryCommand } from '@aws-sdk/lib-dynamodb';
import { getMilliseconds } from '../layer-date/index.mjs';
import { ddbDocClient } from './ddbDocClient.mjs';

const getUser = async (event) => {
  const { token } = event.queryStringParameters;
  const expirationDate = getMilliseconds(event.requestContext.timeEpoch) - 864e5;
  const params = {
    TableName: 'user',
    IndexName: 'userIndex',
    KeyConditionExpression: 'tokenCode = :c and loginDate > :d',
    ExpressionAttributeValues: {
      ':c': token,
      ':d': expirationDate,
    },
  };
  const data = await ddbDocClient.send(new QueryCommand(params));
  const user = data.Items[0];
  return user;
};

export { getUser };
